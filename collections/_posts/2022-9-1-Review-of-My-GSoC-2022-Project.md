---
layout: article
title: Review of My GSoC-2022 Project
categories: Programming
tags: zephyr embedded
eyeCatcher: https://sdtelectronics.github.io/assets/gallery/2022-9-1-Review-of-My-GSoC-2022-Project.jpg
abstract: A brief summary to the GSoC-2022 Project - thrift for zephyr, which I have contributed to.
---

This post is written for the [Google Summer of Code 2022](https://summerofcode.withgoogle.com) project -  thrift for zephyr. Check the [Git repository](https://github.com/zephyrproject-rtos/gsoc-2022-thrift) and the [project proposal](https://summerofcode.withgoogle.com/proposals/details/CROr49Ia) for more context.

## Motivation
Burst data exchange between devices and servers is a typical pattern of communication in IoT applications. By its nature, a [Remote Procedure Call (RPC)](https://en.wikipedia.org/wiki/Remote_procedure_call) framework backs up this kind of services well, and is an approach much superior than implementing everything from scratch in terms of robustness and maintainability. On the other hand, what may concern IoT developers when adopting such frameworks is the limited resources on embedded platforms, therefore, existing frameworks may not be ready for use without modification. Seeing the need of a lightweight RPC framework in the Zephyr ecosystem, this project was started, in the hope that the community could develop innovative apps rapidly with it. 

## Choose the wheel
With the wide spectrum of existing RPC frameworks, we definitely don't have a good reason to reinvent the wheel. The problem is which one is more suitable as the foundation of our work. With the tight constraint of hardware resources in mind, [Apache Thrift](https://thrift.apache.org/) became the ultimate choice, but Thrift also offers much more than its small footprint. Originated from Facebook and evolved for years as an Apache project, Thrift is a proven framework driving thousands of services around the world. With its cross-language capability, developers can drive the application with their favourite technology. And most importantly, Benefiting from its stacked architecture and rich components, serialization and security features can be added in a snap to the application, which is significant to IoT services with critical transportation requirements.

## Challenges of integration
The core of the Thrift framework is quite light and self-contained, hence not much change was required to make it work on Zephyr. This still took some effort, though, mainly due to the rudimentary support to POSIX APIs and C++ on Zephyr, especially for the absent synchronization facilities. When performing the integration test, there was even a [bug](https://github.com/zephyrproject-rtos/zephyr/pull/47610) detected in the upstream. With these issues fixed (or circumvented), the core function set of Thrift runs pretty well on Zephyr, and this is backed up by the test suite. On the other hand, basic functions are simply not satisfactory, as a great attraction of Thrift is its rich components. Not all of them were ported in this module, and the decision was made based on the importance of each feature to the IoT applications. The final candidates were compact protocol, Zlib transport and TLS transport. The compact protocol has no external dependency and was kinda work-out-of-box. Major challenges came from the later two, as we will see below.

### Zlib transport
As its name suggests, Zlib transport applies [Zlib](https://www.rfc-editor.org/rfc/rfc1950) compression to the payload to speedup the transportation. This is important to IoT devices connected wirelessly and powered by battery, as radio-frequency communication is very power-demanding. Obviously, this feature depends on Zlib for compression, while Zlib is too heavy for many embedded platforms. Therefore, the idea was to replace Zlib with a lightweight alternative, and unsurprisingly there are such libraries available - but not really. A subtle feature of Zlib is the capability of processing chunks of incomplete data on-the-fly, and this is required by the Zlib transport. This is formally called as streaming mode, which requires additional care to intermediate states and data alignment. It turned out that there's no available library supports both compression and decompression of Zlib data in streaming mode, and most of the existing libraries exposed interfaces very different from Zlib. After assessing the workload, It was decided to make a new library based on two existing works. The first one is [uzlib](https://github.com/pfalcon/uzlib), which provided the compressor, and an encapsulation has to be written to add the streaming capability to it. The second one is [Inflater](https://github.com/martin-rizzo/Inflater), which is the base of the decompressor. Combing this two parts together, a lightweight compression library was created. It was named as [muzic](https://github.com/SdtElectronics/muzic), where "mu" means tiny, and "zic" means Zlib-interface-compatible. Benchmarks showed significant saving of ROM and RAM with muzic in comparison with zlib, portraying it as a strong alternative to zlib on embedded platforms.

### TLS transport
For IoT services deployed on a open network, you definitely want to have the data encrypted and have the peer verified. This is when TLS transport becomes handy. With the TLS protocol originally implemented by OpenSSL, the TLS protocol also faced the same issue  of resource requirement. The solution was a bit simpler than what was done for the Zlib transport as the alternative implementation of TLS has already been integrated in Zephyr: the [mbedTLS](https://tls.mbed.org/) library. Thanks to this, the integration of TLS transport can be done by substituting OpenSSL APIs, without "inventing your own cryptography" (well, "implementing your own cryptography" could be more precise here), which is known to be risky for laymen. 

## Try it yourself
Sounds interesting, but have no previous experience on Thrift? We have a simple example to get you covered. Check [the sample application](https://github.com/zephyrproject-rtos/gsoc-2022-thrift/blob/main/samples/lib/thrift/) to see how to write a simple Thrift IDL and wire everything up together. It can be run on QEMU so no extra hardware is required. To use this module in your project, simply add it to the manifest, or use a submanifest as our [README](https://github.com/zephyrproject-rtos/gsoc-2022-thrift/blob/main/README.md) page suggested. To learn more about Thrift, please refer to its [official documentation](https://thrift.apache.org/docs/).

## Conclusion
With all of its device drivers, network stacks and rich libraries, Zephyr stands out as the foundation of the next-generation IoT products. Now that the Thrift is introduced to the Zephyr ecosystem, not only the hardware level of details are hidden, but also the low-level network communication is abstracted away. IoT developers can focus on the logic of their services and iterate rapidly even on the most resource-constrained platforms. Finally, as a part of the Google Summer of Code (GSoC) 2022 program, this project wouldn't success without the support from the GSoC and Zephyr community. Especially, I want to thank two mentors [Christopher Friedt](https://github.com/cfriedt) and [Stephanos Ioannidis](https://github.com/stephanosio) who gave this brilliant project idea and helped me throughout the coding period. Hope you'll enjoy our work!
